name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

permissions:
    contents: read
    packages: write

jobs:
    backend:
        name: Backend Lint & Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: backend
        env:
            NODE_ENV: test
            DB_TYPE: sqlite
            SQLITE_DB_PATH: dev.sqlite3
            JWT_SECRET: ci-jwt-secret
            JWT_REFRESH_SECRET: ci-refresh-secret
            TELEMETRY_INGEST_KEY: ci-ingest-key
            STRIPE_ENABLED: "false"
            FCM_ENABLED: "false"
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: npm
                  cache-dependency-path: backend/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Lint
              run: npm run lint:check

            - name: Unit tests
              run: npm run test

            - name: E2E tests
              run: npm run test:e2e

            - name: Build
              run: npm run build

    flutter:
        name: Flutter Analyze & Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: flutter
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable

            - name: Cache pub dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.pub-cache
                      flutter/.dart_tool
                  key: ${{ runner.os }}-pub-${{ hashFiles('flutter/pubspec.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-pub-

            - name: Flutter pub get
              run: flutter pub get

            - name: Flutter analyze
              run: flutter analyze

            - name: Flutter tests
              run: flutter test

    docker-image:
        name: Backend Docker Build & Push
        runs-on: ubuntu-latest
        needs:
            - backend
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push image
              uses: docker/build-push-action@v6
              with:
                  context: ./backend
                  file: backend/Dockerfile
                  push: ${{ github.event_name != 'pull_request' }}
                  tags: |
                      ghcr.io/tiagofur/ppn-backend:${{ github.sha }}
                      ghcr.io/tiagofur/ppn-backend:staging

    deploy:
        name: Staging Deploy
        runs-on: ubuntu-latest
        needs:
            - docker-image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.0
              env:
                  STAGING_SSH_HOST: ${{ secrets.STAGING_SSH_HOST }}
                  STAGING_SSH_USER: ${{ secrets.STAGING_SSH_USER }}
                  STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
              with:
                  host: ${{ env.STAGING_SSH_HOST }}
                  username: ${{ env.STAGING_SSH_USER }}
                  key: ${{ env.STAGING_SSH_KEY }}
                  port: 22
                  script: |
                      set -euo pipefail
                      cd /opt/ppn
                      docker compose pull
                      docker compose up -d
                      docker system prune -f
