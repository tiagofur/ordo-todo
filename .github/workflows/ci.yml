name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

permissions:
    contents: read
    packages: write

env:
    NODE_VERSION: "20"
    REGISTRY: ghcr.io
    BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/ordo-todo-backend
    WEB_IMAGE: ghcr.io/${{ github.repository_owner }}/ordo-todo-web

jobs:
    # =============================================================================
    # Shared Packages Build
    # =============================================================================
    packages:
        name: Build Shared Packages
        runs-on: ubuntu-latest
        env:
            DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Setup Python (for native modules)
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'

            - name: Install build tools
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential

            - name: Install dependencies
              run: |
                  # Force git to use HTTPS instead of SSH for GitHub dependencies
                  git config --global url."https://github.com/".insteadOf "git@github.com:"
                  git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
                  
                  MAX_RETRIES=3
                  RETRY_COUNT=0
                  SUCCESS=false
                  
                  until [ $RETRY_COUNT -ge $MAX_RETRIES ] || [ "$SUCCESS" = true ]
                  do
                    echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES..."
                    if [ -f package-lock.json ]; then
                      if npm ci --legacy-peer-deps; then SUCCESS=true; fi
                    else
                      if npm install --legacy-peer-deps; then SUCCESS=true; fi
                    fi
                    
                    if [ "$SUCCESS" = true ]; then
                      break
                    fi
                    
                    RETRY_COUNT=$((RETRY_COUNT+1))
                    echo "Installation failed. Waiting 15 seconds before retry..."
                    sleep 15
                  done
                  
                  if [ "$SUCCESS" != true ]; then
                    echo "Failed to install dependencies after $MAX_RETRIES attempts."
                    exit 1
                  fi

            - name: Generate Prisma client
              run: npx prisma generate --schema=prisma/schema.prisma
              working-directory: packages/db

            - name: Build packages
              run: npm run build

            - name: Cache packages
              uses: actions/cache@v5
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

    # =============================================================================
    # Backend (NestJS)
    # =============================================================================
    backend:
        name: Backend Lint & Tests
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/backend
        env:
            NODE_ENV: test
            PORT: 3001
            API_PREFIX: api
            DATABASE_URL: postgresql://postgres:postgres@localhost:5432/ordo_todo_test
            JWT_SECRET: ci-jwt-secret-that-is-at-least-32-characters-long
            JWT_EXPIRATION: 1d
            JWT_REFRESH_EXPIRATION: 7d
            CORS_ORIGINS: http://localhost:3000
        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: ordo_todo_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Setup Python (for native modules)
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'

            - name: Install build tools
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential

            - name: Restore packages cache
              uses: actions/cache@v5
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: |
                  # Force git to use HTTPS instead of SSH for GitHub dependencies
                  git config --global url."https://github.com/".insteadOf "git@github.com:"
                  git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
                  
                  MAX_RETRIES=3
                  RETRY_COUNT=0
                  SUCCESS=false
                  
                  until [ $RETRY_COUNT -ge $MAX_RETRIES ] || [ "$SUCCESS" = true ]
                  do
                    echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES..."
                    if [ -f package-lock.json ]; then
                      if npm ci --legacy-peer-deps; then SUCCESS=true; fi
                    else
                      if npm install --legacy-peer-deps; then SUCCESS=true; fi
                    fi
                    
                    if [ "$SUCCESS" = true ]; then
                      break
                    fi
                    
                    RETRY_COUNT=$((RETRY_COUNT+1))
                    echo "Installation failed. Waiting 15 seconds before retry..."
                    sleep 15
                  done
                  
                  if [ "$SUCCESS" != true ]; then
                    echo "Failed to install dependencies after $MAX_RETRIES attempts."
                    exit 1
                  fi
              working-directory: .

            - name: Generate Prisma client
              run: npx prisma generate --schema=prisma/schema.prisma
              working-directory: packages/db

            - name: Run database migrations
              run: npx prisma migrate deploy --schema=prisma/schema.prisma
              working-directory: packages/db

            - name: Lint
              run: npm run lint

            - name: Unit tests
              run: npm run test

            - name: E2E tests
              run: npm run test:e2e

            - name: Build
              run: npm run build

    # =============================================================================
    # Web (Next.js)
    # =============================================================================
    web:
        name: Web Lint & Build
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/web
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Setup Python (for native modules)
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'

            - name: Install build tools
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential

            - name: Restore packages cache
              uses: actions/cache@v5
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: |
                  # Force git to use HTTPS instead of SSH for GitHub dependencies
                  git config --global url."https://github.com/".insteadOf "git@github.com:"
                  git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
                  
                  MAX_RETRIES=3
                  RETRY_COUNT=0
                  SUCCESS=false
                  
                  until [ $RETRY_COUNT -ge $MAX_RETRIES ] || [ "$SUCCESS" = true ]
                  do
                    echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES..."
                    if [ -f package-lock.json ]; then
                      if npm ci --legacy-peer-deps; then SUCCESS=true; fi
                    else
                      if npm install --legacy-peer-deps; then SUCCESS=true; fi
                    fi
                    
                    if [ "$SUCCESS" = true ]; then
                      break
                    fi
                    
                    RETRY_COUNT=$((RETRY_COUNT+1))
                    echo "Installation failed. Waiting 15 seconds before retry..."
                    sleep 15
                  done
                  
                  if [ "$SUCCESS" != true ]; then
                    echo "Failed to install dependencies after $MAX_RETRIES attempts."
                    exit 1
                  fi
              working-directory: .

            - name: Lint
              run: npm run lint

            - name: Type check
              run: npm run check-types

            - name: Build
              run: npm run build
              env:
                  NEXT_PUBLIC_API_URL: http://localhost:3001

    # =============================================================================
    # Desktop (Electron)
    # =============================================================================
    desktop:
        name: Desktop Lint & Build
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/desktop
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Setup Python (for native modules)
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'

            - name: Install build tools
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential

            - name: Restore packages cache
              uses: actions/cache@v5
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: |
                  # Force git to use HTTPS instead of SSH for GitHub dependencies
                  git config --global url."https://github.com/".insteadOf "git@github.com:"
                  git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
                  
                  MAX_RETRIES=3
                  RETRY_COUNT=0
                  SUCCESS=false
                  
                  until [ $RETRY_COUNT -ge $MAX_RETRIES ] || [ "$SUCCESS" = true ]
                  do
                    echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES..."
                    if [ -f package-lock.json ]; then
                      if npm ci --legacy-peer-deps; then SUCCESS=true; fi
                    else
                      if npm install --legacy-peer-deps; then SUCCESS=true; fi
                    fi
                    
                    if [ "$SUCCESS" = true ]; then
                      break
                    fi
                    
                    RETRY_COUNT=$((RETRY_COUNT+1))
                    echo "Installation failed. Waiting 15 seconds before retry..."
                    sleep 15
                  done
                  
                  if [ "$SUCCESS" != true ]; then
                    echo "Failed to install dependencies after $MAX_RETRIES attempts."
                    exit 1
                  fi
              working-directory: .

            - name: Lint
              run: npm run lint

            - name: Build Vite bundle
              run: npm run build:vite

    # =============================================================================
    # Mobile (React Native + Expo)
    # =============================================================================
    mobile:
        name: Mobile Lint & Type Check
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/mobile
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Setup Python (for native modules)
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'

            - name: Install build tools
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential

            - name: Restore packages cache
              uses: actions/cache@v5
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: |
                  # Force git to use HTTPS instead of SSH for GitHub dependencies
                  git config --global url."https://github.com/".insteadOf "git@github.com:"
                  git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
                  
                  MAX_RETRIES=3
                  RETRY_COUNT=0
                  SUCCESS=false
                  
                  until [ $RETRY_COUNT -ge $MAX_RETRIES ] || [ "$SUCCESS" = true ]
                  do
                    echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES..."
                    if [ -f package-lock.json ]; then
                      if npm ci --legacy-peer-deps; then SUCCESS=true; fi
                    else
                      if npm install --legacy-peer-deps; then SUCCESS=true; fi
                    fi
                    
                    if [ "$SUCCESS" = true ]; then
                      break
                    fi
                    
                    RETRY_COUNT=$((RETRY_COUNT+1))
                    echo "Installation failed. Waiting 15 seconds before retry..."
                    sleep 15
                  done
                  
                  if [ "$SUCCESS" != true ]; then
                    echo "Failed to install dependencies after $MAX_RETRIES attempts."
                    exit 1
                  fi
              working-directory: .

            - name: Lint
              run: npm run lint

            - name: Type check
              run: npx tsc --noEmit

    # =============================================================================
    # Docker Image (Backend)
    # =============================================================================
    docker-backend:
        name: Backend Docker Build & Push
        runs-on: ubuntu-latest
        needs:
            - backend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: apps/backend/Dockerfile
                  push: true
                  tags: |
                      ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
                      ${{ env.BACKEND_IMAGE }}:latest

    docker-web:
        name: Web Docker Build & Push
        runs-on: ubuntu-latest
        needs:
            - web
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: apps/web/Dockerfile
                  push: true
                  tags: |
                      ${{ env.WEB_IMAGE }}:${{ github.sha }}
                      ${{ env.WEB_IMAGE }}:latest
                  build-args: |
                      NEXT_PUBLIC_API_URL=https://api.ordotodo.app
                      NEXTAUTH_URL=https://ordotodo.app

    # =============================================================================
    # Deploy (Optional - Staging)
    # NOTE: This job is disabled. Production deployment is handled by deploy.yml
    # To enable staging, configure these secrets: STAGING_SSH_HOST, STAGING_SSH_USER, STAGING_SSH_KEY
    # =============================================================================
    # deploy:
    #     name: Staging Deploy
    #     runs-on: ubuntu-latest
    #     needs:
    #         - docker-backend
    #         - docker-web
    #     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    #     environment: staging
    #     steps:
    #         - name: Deploy via SSH
    #           uses: appleboy/ssh-action@v1.0.0
    #           with:
    #               host: ${{ secrets.STAGING_SSH_HOST }}
    #               username: ${{ secrets.STAGING_SSH_USER }}
    #               key: ${{ secrets.STAGING_SSH_KEY }}
    #               port: 22
    #               script: |
    #                   set -euo pipefail
    #                   cd /opt/ordo-todo
    #                   docker compose pull
    #                   docker compose up -d
    #                   docker system prune -f
