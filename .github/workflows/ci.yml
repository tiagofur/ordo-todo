name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

permissions:
    contents: read
    packages: write

env:
    NODE_VERSION: "20"

jobs:
    # =============================================================================
    # Shared Packages Build
    # =============================================================================
    packages:
        name: Build Shared Packages
        runs-on: ubuntu-latest
        env:
            DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Generate Prisma client
              run: npx prisma generate --schema=prisma/schema.prisma
              working-directory: packages/db

            - name: Build packages
              run: npm run build --workspaces --if-present || true

            - name: Cache packages
              uses: actions/cache@v4
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

    # =============================================================================
    # Backend (NestJS)
    # =============================================================================
    backend:
        name: Backend Lint & Tests
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/backend
        env:
            NODE_ENV: test
            DATABASE_URL: postgresql://postgres:postgres@localhost:5432/ordo_todo_test
            JWT_SECRET: ci-jwt-secret
            JWT_REFRESH_SECRET: ci-refresh-secret
        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: ordo_todo_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Restore packages cache
              uses: actions/cache@v4
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: npm ci
              working-directory: .

            - name: Generate Prisma client
              run: npx prisma generate --schema=prisma/schema.prisma
              working-directory: packages/db

            - name: Run database migrations
              run: npx prisma migrate deploy --schema=prisma/schema.prisma
              working-directory: packages/db

            - name: Lint
              run: npm run lint || true

            - name: Unit tests
              run: npm run test || true

            - name: E2E tests
              run: npm run test:e2e || true

            - name: Build
              run: npm run build

    # =============================================================================
    # Web (Next.js)
    # =============================================================================
    web:
        name: Web Lint & Build
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/web
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Restore packages cache
              uses: actions/cache@v4
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: npm ci
              working-directory: .

            - name: Lint
              run: npm run lint || true

            - name: Type check
              run: npm run check-types || true

            - name: Build
              run: npm run build
              env:
                  NEXT_PUBLIC_API_URL: http://localhost:3001

    # =============================================================================
    # Desktop (Electron)
    # =============================================================================
    desktop:
        name: Desktop Lint & Build
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/desktop
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Restore packages cache
              uses: actions/cache@v4
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: npm ci
              working-directory: .

            - name: Lint
              run: npm run lint || true

            - name: Build Vite bundle
              run: npm run build:vite

    # =============================================================================
    # Mobile (React Native + Expo)
    # =============================================================================
    mobile:
        name: Mobile Lint & Type Check
        runs-on: ubuntu-latest
        needs: packages
        defaults:
            run:
                working-directory: apps/mobile
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm

            - name: Restore packages cache
              uses: actions/cache@v4
              with:
                  path: |
                      packages/*/dist
                      packages/*/.turbo
                  key: ${{ runner.os }}-packages-${{ github.sha }}

            - name: Install dependencies
              run: npm ci
              working-directory: .

            - name: Lint
              run: npm run lint || true

            - name: Type check
              run: npx tsc --noEmit || true

    # =============================================================================
    # Docker Image (Backend)
    # =============================================================================
    docker-image:
        name: Backend Docker Build & Push
        runs-on: ubuntu-latest
        needs:
            - backend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: apps/backend/Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ github.repository_owner }}/ordo-todo-backend:${{ github.sha }}
                      ghcr.io/${{ github.repository_owner }}/ordo-todo-backend:latest

    # =============================================================================
    # Deploy (Optional - Staging)
    # =============================================================================
    deploy:
        name: Staging Deploy
        runs-on: ubuntu-latest
        needs:
            - docker-image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        environment: staging
        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.STAGING_SSH_HOST }}
                  username: ${{ secrets.STAGING_SSH_USER }}
                  key: ${{ secrets.STAGING_SSH_KEY }}
                  port: 22
                  script: |
                      set -euo pipefail
                      cd /opt/ordo-todo
                      docker compose pull
                      docker compose up -d
                      docker system prune -f
