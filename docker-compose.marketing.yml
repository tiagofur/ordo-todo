# =============================================================================
# Docker Compose - Marketing Site (ordotodo.com)
# Place this file on your VPS at /opt/ordo-todo-marketing/docker-compose.marketing.yml
# =============================================================================

version: '3.8'

services:
  # Marketing Backend API (api.ordotodo.com)
  marketing-backend:
    image: ghcr.io/tiagofur/ordo-todo-marketing-backend:${IMAGE_TAG:-latest}
    container_name: ordo-marketing-backend
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - DATABASE_URL=${DATABASE_URL}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - marketing-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.marketing-backend.rule=Host(`api.ordotodo.com`)"
      - "traefik.http.routers.marketing-backend.entrypoints=websecure"
      - "traefik.http.routers.marketing-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.marketing-backend.loadbalancer.server.port=4000"

  # Marketing Web (ordotodo.com)
  marketing-web:
    image: ghcr.io/tiagofur/ordo-todo-marketing-web:${IMAGE_TAG:-latest}
    container_name: ordo-marketing-web
    restart: unless-stopped
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://api.ordotodo.com
    depends_on:
      - marketing-backend
    networks:
      - marketing-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.marketing-web.rule=Host(`ordotodo.com`) || Host(`www.ordotodo.com`)"
      - "traefik.http.routers.marketing-web.entrypoints=websecure"
      - "traefik.http.routers.marketing-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.marketing-web.loadbalancer.server.port=3000"
      # Redirect www to non-www
      - "traefik.http.middlewares.marketing-www-redirect.redirectregex.regex=^https://www\\.ordotodo\\.com/(.*)"
      - "traefik.http.middlewares.marketing-www-redirect.redirectregex.replacement=https://ordotodo.com/$${1}"
      - "traefik.http.routers.marketing-web.middlewares=marketing-www-redirect"

networks:
  marketing-network:
    driver: bridge
