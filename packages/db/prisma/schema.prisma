// schema.prisma

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============ USER & AUTH ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  emailVerified DateTime?
  name          String
  image         String?

  // Extended Profile
  phone                String?
  jobTitle             String?
  department           String?
  bio                  String?   @db.Text
  timezone             String?   @default("America/Mexico_City")
  locale               String?   @default("es")
  lastUsernameChangeAt DateTime? // For 30-day username change cooldown

  // Auth
  hashedPassword String?
  accounts       Account[]
  sessions       Session[]

  // Settings
  preferences  UserPreferences?
  subscription Subscription?

  // Relationships
  workspaces      WorkspaceMember[]
  ownedWorkspaces Workspace[]       @relation("OwnedWorkspaces")
  ownedTasks      Task[]            @relation("CreatedTasks")
  assignedTasks   Task[]            @relation("AssignedTasks")
  ownedProjects   Project[]
  notes           Note[]
  meetings      Meeting[]         @relation("MeetingOwner")

  comments        Comment[]         @relation("UserComments")
  attachments     Attachment[]      @relation("UploadedAttachments")
  activities      Activity[]        @relation("UserActivities")
  notifications   Notification[]

  // Workspace Management
  sentInvitations WorkspaceInvitation[] @relation("SentInvitations")
  auditLogs       WorkspaceAuditLog[]    @relation("AuditLogs")

  // AI Data
  aiProfile           AIProfile?
  productivityReports ProductivityReport[]
  chatConversations   ChatConversation[]

  // Habits
  habits Habit[]

  // OKRs
  objectives Objective[]

  // Third-party Integrations
  integrations UserIntegration[]

  // Gamification
  xp           Int               @default(0)
  level        Int               @default(1)
  achievements UserAchievement[]

  // Marketing & Community
  blogComments           BlogComment[]
  newsletterSubscription NewsletterSubscriber?
  roadmapVotes           RoadmapVote[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ CHANGELOG ============

model ChangelogEntry {
  id      String        @id @default(cuid())
  version String?
  title   String
  content String        @db.Text
  type    ChangelogType @default(NEW)

  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum ChangelogType {
  NEW
  IMPROVED
  FIXED
  REMOVED
}

// ============ FAQ ============

model FAQ {
  id        String  @id @default(cuid())
  question  String
  answer    String  @db.Text
  category  String
  order     Int     @default(0)
  published Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ KNOWLEDGE BASE ============

model KBCategory {
  id    String  @id @default(cuid())
  name  String
  slug  String  @unique
  icon  String?
  order Int     @default(0)

  articles KBArticle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KBArticle {
  id      String  @id @default(cuid())
  slug    String  @unique
  title   String
  content String  @db.Text
  excerpt String?

  category   KBCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String

  helpfulYes Int     @default(0)
  helpfulNo  Int     @default(0)
  published  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ NEWSLETTER ============

model NewsletterSubscriber {
  id     String  @id @default(cuid())
  email  String  @unique
  active Boolean @default(true)

  // Optional link to user account
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String? @unique // One subscription per user

  createdAt DateTime @default(now())
}

// ============ CONTACT ============

model ContactSubmission {
  id      String  @id @default(cuid())
  name    String
  email   String
  subject String
  message String  @db.Text
  read    Boolean @default(false)

  createdAt DateTime @default(now())
}

// ============ ROADMAP ============

model RoadmapItem {
  id          String        @id @default(cuid())
  title       String
  description String        @db.Text
  status      RoadmapStatus @default(CONSIDERING)
  totalVotes  Int           @default(0) // Weighted vote count

  // Relations
  votes RoadmapVote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RoadmapVote {
  id String @id @default(cuid())

  item   RoadmapItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  weight Int @default(1) // Based on subscription: Free=1, Pro=3, Team=5

  createdAt DateTime @default(now())

  @@unique([itemId, userId]) // One vote per user per item
}

enum RoadmapStatus {
  CONSIDERING
  PLANNED
  IN_PROGRESS
  COMPLETED
  DECLINED
}

// ============ ADMIN ============

model AdminUser {
  id             String @id @default(cuid())
  email          String @unique
  hashedPassword String
  name           String
  role           String @default("admin")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ NOTIFICATIONS ============

model Notification {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  type    NotificationType
  title   String
  message String?

  // Link to related entity (polymorphic-ish)
  resourceId   String?
  resourceType ResourceType?

  // Metadata for navigation (e.g., workspaceId, projectId)
  metadata Json?

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  // PERFORMANCE: Query notifications by resource
  @@index([resourceId, resourceType])
}

enum NotificationType {
  TASK_ASSIGNED
  COMMENT_ADDED
  MENTIONED
  DUE_DATE_APPROACHING
  INVITATION_RECEIVED
  SYSTEM
}

enum ResourceType {
  TASK
  PROJECT
  WORKSPACE
  COMMENT
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timer Settings
  timerMode               TimerMode @default(POMODORO)
  pomodoroDuration        Int       @default(25) // minutes
  shortBreakDuration      Int       @default(5)
  longBreakDuration       Int       @default(15)
  pomodorosUntilLongBreak Int       @default(4)

  // Notifications
  enableSounds        Boolean @default(true)
  enableNotifications Boolean @default(true)

  // UI
  theme       Theme    @default(LIGHT)
  startOfWeek Int      @default(1) // 0=Sunday, 1=Monday
  defaultView ViewType @default(LIST)

  // AI General
  enableAI         Boolean @default(true)
  aiAggressiveness Int     @default(5) // 1-10 scale

  // AI Granular Settings
  aiSuggestTaskDurations Boolean @default(true)
  aiSuggestPriorities    Boolean @default(true)
  aiSuggestScheduling    Boolean @default(true)
  aiWeeklyReports        Boolean @default(true)

  // Energy Profile (for Energy Matching)
  morningEnergy   EnergyLevel @default(MEDIUM)
  afternoonEnergy EnergyLevel @default(MEDIUM)
  eveningEnergy   EnergyLevel @default(LOW)

  // Privacy Settings
  shareAnalytics     Boolean @default(true)
  showActivityStatus Boolean @default(true)

  // Email Notifications
  taskRemindersEmail Boolean @default(false)
  weeklyDigestEmail  Boolean @default(true)
  marketingEmail     Boolean @default(false)

  // Data Retention (null = never delete, else number of days)
  completedTasksRetention Int?
  timeSessionsRetention   Int?

  // Extended JSON data
  focusAudio Json?
}

// ============ USER INTEGRATIONS ============

model UserIntegration {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  provider       IntegrationProvider
  accessToken    String?             @db.Text
  refreshToken   String?             @db.Text
  expiresAt      DateTime?
  scope          String?
  providerUserId String?
  providerEmail  String?

  settings   Json? // Provider-specific settings
  isActive   Boolean   @default(true)
  lastSyncAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider])
  @@index([userId])
}

enum IntegrationProvider {
  GOOGLE_CALENDAR
  GOOGLE_TASKS
  SLACK
  GITHUB
  MICROSOFT_TEAMS
  NOTION
  ZAPIER
}

enum TimerMode {
  POMODORO
  CONTINUOUS
  HYBRID
}

enum Theme {
  LIGHT
  DARK
  AUTO
}

enum ViewType {
  LIST
  KANBAN
  CALENDAR
  TIMELINE
  FOCUS
}

enum EnergyLevel {
  LOW
  MEDIUM
  HIGH
}

// ============ WORKSPACES ============

model Workspace {
  id          String        @id @default(cuid())
  name        String
  slug        String
  description String?
  type        WorkspaceType
  tier        WorkspaceTier @default(FREE) // NUEVO: Preparado para monetización futura
  color       String        @default("#2563EB")
  icon        String?

  // Owner
  ownerId String?
  owner   User?   @relation("OwnedWorkspaces", fields: [ownerId], references: [id], onDelete: Cascade)

  // Members
  members WorkspaceMember[]

  // Content
  workflows Workflow[]
  projects  Project[]
  tags      Tag[]

  // NUEVAS RELACIONES
  settings      WorkspaceSettings?
  invitations   WorkspaceInvitation[]
  audits        WorkspaceAuditLog[]
  taskTemplates TaskTemplate[]
  objectives    Objective[]
  notes         Note[]
  meetings      Meeting[]         @relation("WorkspaceMeetings")


  // NUEVO: Estados de ciclo de vida
  isArchived Boolean   @default(false)
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerId, slug])
  @@index([ownerId])
  @@index([slug])
  @@index([deletedAt])
  @@index([isDeleted])
}

enum WorkspaceTier {
  FREE
  PRO
  ENTERPRISE
}

// NUEVO: Configuraciones específicas del workspace
model WorkspaceSettings {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String    @unique

  defaultView    ViewType? @default(LIST)
  defaultDueTime Int? // minutos desde inicio del día
  timezone       String? // ej. "America/Mexico_City"
  locale         String? // ej. "es-MX"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NUEVO: Gestión de invitaciones
model WorkspaceInvitation {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String

  email     String
  tokenHash String // Hash del token para seguridad
  role      MemberRole   @default(MEMBER)
  status    InviteStatus @default(PENDING)

  // SECURITY: onDelete: SetNull - When inviter is deleted, remove inviter reference but keep invitation
  invitedById String?
  invitedBy   User?   @relation("SentInvitations", fields: [invitedById], references: [id], onDelete: SetNull)

  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([email])
  @@index([invitedById])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// NUEVO: Logs de auditoría (Importante para planes TEAM/ENTERPRISE)
model WorkspaceAuditLog {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // SECURITY: onDelete: SetNull - When actor is deleted, remove actor reference but keep audit log
  actorId String? // Usuario que realizó la acción
  actor   User?   @relation("AuditLogs", fields: [actorId], references: [id], onDelete: SetNull)

  action  String // ej. "MEMBER_INVITED", "PROJECT_DELETED"
  payload Json? // Detalles del cambio

  createdAt DateTime @default(now())

  @@index([workspaceId, createdAt])
  @@index([actorId])
}

enum WorkspaceType {
  PERSONAL
  WORK
  TEAM
}

model WorkspaceMember {
  id String @id @default(cuid())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  role MemberRole @default(MEMBER)

  joinedAt DateTime @default(now())

  @@unique([workspaceId, userId])
  @@index([userId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============ WORKFLOWS ============

model Workflow {
  id          String  @id @default(cuid())
  name        String
  description String?
  color       String  @default("#6B7280")
  icon        String?

  // Workspace
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String

  // Content
  projects Project[]

  // Organization
  position Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}

// ============ PROJECTS & TASKS ============

model Project {
  id          String  @id @default(cuid())
  name        String
  slug        String // Único por workspace
  description String?

  // Status & Priority
  status   ProjectStatus @default(ACTIVE)
  priority Priority      @default(MEDIUM)

  // Appearance
  color String  @default("#6B7280")
  icon  String?

  // Dates
  startDate DateTime?
  dueDate   DateTime?

  // Owner
  ownerId String?
  owner   User?   @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  // Workspace
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String

  // Workflow
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  workflowId String

  // Organization
  position    Int       @default(0)
  archived    Boolean   @default(false)
  completed   Boolean   @default(false)
  completedAt DateTime?

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Content
  tasks Task[]
  meetings Meeting[]

  // Metrics (Denormalized)
  tasksCount          Int @default(0)
  completedTasksCount Int @default(0)

  // Settings (JSON)
  settings Json?

  // Productivity Reports
  reports ProductivityReport[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Custom Fields
  customFields CustomField[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([workflowId])
  @@index([ownerId])
  @@index([deletedAt])
  // PERFORMANCE: Filter by status and completion state
  @@index([completed])
  @@index([archived])
  @@index([status])
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

// ============ CUSTOM FIELDS ============

enum CustomFieldType {
  TEXT
  NUMBER
  SELECT
  MULTI_SELECT
  DATE
  URL
  EMAIL
  CHECKBOX
}

model CustomField {
  id          String          @id @default(cuid())
  name        String
  type        CustomFieldType
  description String?
  options     Json? // For SELECT/MULTI_SELECT: ["Option 1", "Option 2"]
  isRequired  Boolean         @default(false)
  position    Int             @default(0)

  // Relations
  project   Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  values    CustomFieldValue[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

model CustomFieldValue {
  id    String @id @default(cuid())
  value String @db.Text // Stored as string, parsed based on field type

  // Relations
  field   CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId String
  task    Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId  String

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fieldId, taskId])
  @@index([taskId])
  @@index([fieldId])
}

model Task {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text

  // Status
  status   TaskStatus @default(TODO)
  priority Priority   @default(MEDIUM)

  // Scheduling
  dueDate          DateTime?
  startDate        DateTime?
  scheduledDate    DateTime? // When the task is scheduled to be worked on
  scheduledTime    String? // Time of day scheduled (e.g., "14:30")
  scheduledEndTime String? // End time for time block (e.g., "16:00")
  isTimeBlocked    Boolean   @default(false) // Whether task is time blocked in calendar
  completedAt      DateTime?

  // Time Tracking
  estimatedMinutes Int?
  actualMinutes    Int? @default(0)

  // Sharing
  publicToken String? @unique

  // Organization
  position Int @default(0)

  // Relationships
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  // SECURITY: onDelete: Cascade - When user is deleted, all owned tasks are deleted
  owner   User   @relation("CreatedTasks", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId String

  // SECURITY: onDelete: SetNull - When assignee is deleted, unassign tasks instead of deleting them
  assignee   User?   @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)
  assigneeId String?

  // Hierarchy
  parentTask   Task?   @relation("SubTasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  parentTaskId String?
  subTasks     Task[]  @relation("SubTasks")

  // Dependencies
  blockedBy TaskDependency[] @relation("BlockedTask")
  blocking  TaskDependency[] @relation("BlockingTask")

  // Recurrence
  recurrence Recurrence?

  // Tags & Attachments
  tags        TaskTag[]
  attachments Attachment[]
  comments    Comment[]
  activities  Activity[]

  // AI Metadata
  aiSuggestions  Json? // Stores AI-generated suggestions
  energyRequired EnergyLevel @default(MEDIUM)

  // OKRs - Link to Key Results
  keyResults KeyResultTask[]

  // Custom Field Values
  customFieldValues CustomFieldValue[]

  // Time Sessions
  timeSessions TimeSession[]

  // Productivity Reports
  reports ProductivityReport[]

  // Soft Delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([ownerId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
  @@index([scheduledDate])
  // Composite indexes for common query patterns
  @@index([ownerId, projectId])
  @@index([ownerId, status])
  @@index([projectId, status, dueDate])
  @@index([assigneeId, status, priority])
  @@index([deletedAt])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TaskDependency {
  id String @id @default(cuid())

  blockingTask   Task   @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)
  blockingTaskId String

  blockedTask   Task   @relation("BlockedTask", fields: [blockedTaskId], references: [id], onDelete: Cascade)
  blockedTaskId String

  createdAt DateTime @default(now())

  @@unique([blockingTaskId, blockedTaskId])
}

model Recurrence {
  id String @id @default(cuid())

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String @unique

  pattern    RecurrencePattern
  interval   Int               @default(1) // Every X days/weeks/months
  daysOfWeek Int[] // [0,1,2,3,4,5,6] for Sunday-Saturday
  dayOfMonth Int? // 1-31
  endDate    DateTime?

  createdAt DateTime @default(now())
}

model TaskTemplate {
  id String @id @default(cuid())

  name        String
  description String?
  icon        String? // Lucide icon name

  // Preset Values
  titlePattern            String?
  defaultPriority         Priority @default(MEDIUM)
  defaultEstimatedMinutes Int?
  defaultDescription      String?  @db.Text
  defaultTags             Json? // string[]

  // Owner / Scope
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String

  // Metadata
  isPublic Boolean @default(true) // Visible to all workspace members

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}

enum RecurrencePattern {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

model Tag {
  id    String @id @default(cuid())
  name  String
  color String @default("#6B7280")

  tasks TaskTag[]

  createdAt DateTime @default(now())

  // Workspace
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String?

  @@unique([name, workspaceId])
  @@index([workspaceId]) // PERFORMANCE: Filter tags by workspace
}

model TaskTag {
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId String

  @@id([taskId, tagId])
}

model Attachment {
  id String @id @default(cuid())

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  filename String
  filesize Int // bytes
  mimeType String
  url      String // S3/R2 URL

  // SECURITY: onDelete: SetNull - When uploader is deleted, remove uploader reference but keep file
  uploadedBy   User?   @relation("UploadedAttachments", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?

  uploadedAt DateTime @default(now())

  @@index([taskId])
  @@index([uploadedById])
}

model Comment {
  id String @id @default(cuid())

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  // SECURITY: onDelete: Cascade - When user is deleted, all their comments are deleted
  author   User   @relation("UserComments", fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  content String @db.Text

  // Threaded replies: parent comment for nested comments
  parent   Comment? @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  parentCommentId String?

  // Reverse relation for replies
  replies Comment[] @relation("CommentReplies")

  // User mentions stored as JSON array of user IDs
  mentions String[] @default([])

  // Track if comment has been edited
  isEdited Boolean @default(false)
  editedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([authorId])
  @@index([parentCommentId])
}

model Activity {
  id String @id @default(cuid())

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  // SECURITY: onDelete: Cascade - When user is deleted, all their activity logs are deleted
  user   User   @relation("UserActivities", fields: [userId], references: [id], onDelete: Cascade)
  userId String

  type     ActivityType
  metadata Json? // Stores { oldValue, newValue, fieldName, itemName }

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
  @@index([taskId, createdAt])
}

enum ActivityType {
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  TASK_DELETED
  COMMENT_ADDED
  COMMENT_EDITED
  COMMENT_DELETED
  ATTACHMENT_ADDED
  ATTACHMENT_DELETED
  SUBTASK_ADDED
  SUBTASK_COMPLETED
  STATUS_CHANGED
  PRIORITY_CHANGED
  ASSIGNEE_CHANGED
  DUE_DATE_CHANGED
}

// ============ TIME TRACKING ============

model TimeSession {
  id String @id @default(cuid())

  task   Task?   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String?

  userId String // Who worked on it

  startedAt DateTime
  endedAt   DateTime?
  duration  Int? // minutes (calculated - excludes pause time)

  type SessionType @default(WORK)

  // Pomodoro specific
  wasCompleted   Boolean @default(false)
  wasInterrupted Boolean @default(false)

  // Pause metrics
  pauseCount     Int   @default(0) // Number of pauses during this session
  totalPauseTime Int   @default(0) // Total pause duration in seconds
  pauseData      Json? // Array of pause records: [{ startedAt, endedAt, duration }]

  // Task switching
  parentSessionId String? // If this session is a result of task switch, links to parent
  splitReason     String? // Reason for split: "TASK_SWITCH", "MANUAL_STOP", etc.

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([userId])
  @@index([startedAt])
  @@index([parentSessionId])
  @@index([userId, endedAt])
}

enum SessionType {
  WORK
  SHORT_BREAK
  LONG_BREAK
  CONTINUOUS
}

// ============ AI & ANALYTICS ============

model AIProfile {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Productivity Patterns
  peakHours Json // { hour: productivityScore }
  peakDays  Json // { dayOfWeek: productivityScore }

  // Task Preferences
  avgTaskDuration Int   @default(30) // minutes
  completionRate  Float @default(0.7)

  // Learning
  categoryPreferences Json // What types of tasks user prefers

  updatedAt DateTime @updatedAt
}

model DailyMetrics {
  id String @id @default(cuid())

  userId String
  date   DateTime @db.Date

  // Tasks
  tasksCreated      Int @default(0)
  tasksCompleted    Int @default(0)
  subtasksCompleted Int @default(0) // Track subtasks separately

  // Time
  minutesWorked      Int @default(0)
  pomodorosCompleted Int @default(0)

  // Breaks
  shortBreaksCompleted Int @default(0)
  longBreaksCompleted  Int @default(0)
  breakMinutes         Int @default(0)

  // Focus
  focusScore Float? // 0-1 scale

  createdAt DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

enum ReportScope {
  TASK_COMPLETION
  PROJECT_SUMMARY
  PERSONAL_ANALYSIS
  WEEKLY_SCHEDULED
  MONTHLY_SCHEDULED
}

model ProductivityReport {
  id String @id @default(cuid())

  // Polimórfico: puede ser para task, project o user
  taskId    String?
  projectId String?
  userId    String

  scope ReportScope

  // AI Insights (JSON)
  summary           String @db.Text
  strengths         Json // string[]
  weaknesses        Json // string[]
  recommendations   Json // string[]
  patterns          Json // string[]
  productivityScore Int // 0-100

  // Snapshot de métricas (para histórico)
  metricsSnapshot Json // TaskTimeMetrics serializado

  // Metadata
  generatedAt DateTime @default(now())
  aiModel     String? // "gemini-2.0-flash"

  // Relaciones
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([projectId])
  @@index([userId, scope, generatedAt])
}

// ============ SUBSCRIPTIONS ============

model Subscription {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  plan   SubscriptionPlan
  status SubscriptionStatus

  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubscriptionPlan {
  FREE
  PRO
  TEAM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  TRIALING
  UNPAID
}

// ============ GAMIFICATION ============

model Achievement {
  id          String @id @default(cuid())
  code        String @unique // e.g. "FIRST_TASK"
  name        String
  description String
  icon        String // Lucide icon name or emoji
  xpReward    Int    @default(0)

  users UserAchievement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserAchievement {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  achievementId String

  unlockedAt DateTime @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
}

// ============ HABITS ============

model Habit {
  id String @id @default(cuid())

  // Básicos
  name        String
  description String?
  icon        String? // Lucide icon name
  color       String  @default("#10B981")

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Workspace (optional - habits can be personal)
  workspaceId String?

  // Schedule
  frequency        HabitFrequency @default(DAILY)
  targetDaysOfWeek Int[] // [0,1,2,3,4,5,6] for daily selection
  targetCount      Int            @default(1) // Can complete multiple times per period

  // Time constraints (optional)
  preferredTime String? // "HH:mm" - reminder time
  timeOfDay     TimeOfDay? // MORNING, AFTERNOON, EVENING, ANYTIME

  // Gamification
  currentStreak    Int @default(0)
  longestStreak    Int @default(0)
  totalCompletions Int @default(0)

  // State
  isActive   Boolean   @default(true)
  isPaused   Boolean   @default(false)
  pausedAt   DateTime?
  archivedAt DateTime?

  // Relationships
  completions HabitCompletion[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workspaceId])
}

model HabitCompletion {
  id String @id @default(cuid())

  habit   Habit  @relation(fields: [habitId], references: [id], onDelete: Cascade)
  habitId String

  // When completed
  completedAt   DateTime @default(now())
  completedDate DateTime @db.Date // Date only (for grouping)

  // Optional metadata
  note  String?
  value Float? // For quantifiable habits (e.g., "drank 8 glasses")

  @@unique([habitId, completedDate]) // One completion per day (unless targetCount > 1)
  @@index([habitId])
  @@index([completedDate])
}

enum HabitFrequency {
  DAILY // Every day
  WEEKLY // X times per week
  SPECIFIC_DAYS // Mon, Wed, Fri
  MONTHLY // X times per month
}

enum TimeOfDay {
  MORNING
  AFTERNOON
  EVENING
  ANYTIME
}

// ============ AI CHAT ============

model ChatConversation {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Metadata
  title   String? // Auto-generated from first message or user-defined
  context Json? // Snapshot of context at conversation start (workspaceId, projectId, etc.)

  // Messages
  messages ChatMessage[]

  // Lifecycle
  isArchived Boolean   @default(false)
  archivedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model ChatMessage {
  id String @id @default(cuid())

  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  // Content
  role    ChatRole // 'user' | 'assistant' | 'system'
  content String   @db.Text

  // AI Response Metadata
  metadata Json? // Actions taken, suggestions, model used, tokens, etc.

  // Timestamps
  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([conversationId, createdAt])
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============ OKRs & GOALS ============

model Objective {
  id String @id @default(cuid())

  // Básicos
  title       String
  description String? @db.Text

  // Owner & Scope
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Timeframe
  startDate DateTime  @default(now())
  endDate   DateTime
  period    OKRPeriod @default(QUARTERLY)

  // Status
  status   ObjectiveStatus @default(ACTIVE)
  progress Float           @default(0) // 0-100, calculated from KRs

  // Relationships
  keyResults KeyResult[]

  // Appearance
  color String  @default("#3B82F6")
  icon  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workspaceId])
  @@index([endDate])
}

model KeyResult {
  id String @id @default(cuid())

  // Parent
  objective   Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  objectiveId String

  // Básicos
  title       String
  description String?

  // Measurement
  metricType   MetricType @default(PERCENTAGE)
  startValue   Float      @default(0)
  targetValue  Float
  currentValue Float      @default(0)
  unit         String? // "users", "revenue", "tasks", etc.

  // Progress (calculated)
  progress Float @default(0) // 0-100

  // Relationships
  linkedTasks KeyResultTask[]

  // Timestamps  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([objectiveId])
}

// Join table for linking tasks to Key Results
model KeyResultTask {
  keyResult   KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  keyResultId String

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  // Contribution weight (how much completing this task contributes to KR)
  weight Float @default(1)

  @@id([keyResultId, taskId])
  @@index([taskId]) // PERFORMANCE: Find all key results for a task
}

enum OKRPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum ObjectiveStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  AT_RISK
}

enum MetricType {
  PERCENTAGE // 0-100%
  NUMBER // Absolute number
  CURRENCY // Money
  BOOLEAN // Done/Not done
  TASK_COUNT // Auto-calculated from linked tasks
}

// ============ BLOG ============

model BlogPost {
  id         String  @id @default(cuid())
  slug       String  @unique
  title      String
  excerpt    String? @db.Text
  content    String  @db.Text
  coverImage String?

  published   Boolean   @default(false)
  publishedAt DateTime?

  // SEO
  metaTitle       String?
  metaDescription String?

  // Organization
  author   String?
  category String?
  tags     String[]
  readTime Int?

  // Relations
  comments BlogComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogComment {
  id      String @id @default(cuid())
  content String @db.Text

  // User relation (login required)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Blog post relation
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([postId])
}

// ============ NOTES ============

model Note {
  id      String @id @default(cuid())
  content String @db.Text

  // Position & Style
  x      Int    @default(100)
  y      Int    @default(100)
  width  Int    @default(300)
  height Int    @default(300)
  color  String @default("#feff9c")

  // Workspace
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String

  // Author
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([authorId])
}


// ============ MEETINGS ============

model Meeting {
  id        String   @id @default(cuid())
  userId    String
  title     String
  date      DateTime
  duration  Int // minutes
  transcript String? @db.Text
  audioUrl    String?
  analysis    Json? // MeetingAnalysis as JSON
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  workspaceId String?
  workspace   Workspace? @relation("WorkspaceMeetings", fields: [workspaceId], references: [id], onDelete: Cascade)

  // Author
  author   User   @relation("MeetingOwner", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([date])
  @@index([userId, date])
}
