{"version":3,"sources":["../src/use-username-validation.ts"],"sourcesContent":["import { useState, useCallback, useEffect, useRef } from 'react';\r\nimport type { ApiClient } from './types';\r\n\r\ninterface UsernameValidationResult {\r\n  isValid: boolean;\r\n  isAvailable: boolean | null;\r\n  message: string;\r\n  isLoading: boolean;\r\n}\r\n\r\ninterface UseUsernameValidationOptions {\r\n  apiClient: ApiClient;\r\n  minLength?: number;\r\n  maxLength?: number;\r\n  debounceMs?: number;\r\n  /** Current user's username - if provided, this username is always considered \"available\" */\r\n  currentUsername?: string;\r\n}\r\n\r\nexport function useUsernameValidation({\r\n  apiClient,\r\n  minLength = 3,\r\n  maxLength = 20,\r\n  debounceMs = 500,\r\n  currentUsername,\r\n}: UseUsernameValidationOptions) {\r\n  const [validationResult, setValidationResult] = useState<UsernameValidationResult>({\r\n    isValid: false,\r\n    isAvailable: null,\r\n    message: '',\r\n    isLoading: false,\r\n  });\r\n\r\n  const [lastCheckedUsername, setLastCheckedUsername] = useState<string>('');\r\n\r\n  // Enhanced regex for better username validation\r\n  const usernameRegex = /^[a-z0-9_-]+$/;\r\n\r\n  const validateFormat = useCallback((username: string): { isValid: boolean; message: string } => {\r\n    if (!username || username.length === 0) {\r\n      return { isValid: false, message: 'Username is required' };\r\n    }\r\n\r\n    if (username.length < minLength) {\r\n      return { isValid: false, message: `Username must be at least ${minLength} characters` };\r\n    }\r\n\r\n    if (username.length > maxLength) {\r\n      return { isValid: false, message: `Username must be less than ${maxLength} characters` };\r\n    }\r\n\r\n    if (!usernameRegex.test(username)) {\r\n      return {\r\n        isValid: false,\r\n        message: 'Username can only contain lowercase letters, numbers, hyphens, and underscores',\r\n      };\r\n    }\r\n\r\n    // Additional validation rules\r\n    if (username.startsWith('_') || username.startsWith('-')) {\r\n      return { isValid: false, message: 'Username cannot start with underscore or hyphen' };\r\n    }\r\n\r\n    if (username.endsWith('_') || username.endsWith('-')) {\r\n      return { isValid: false, message: 'Username cannot end with underscore or hyphen' };\r\n    }\r\n\r\n    if (username.includes('--') || username.includes('__')) {\r\n      return { isValid: false, message: 'Username cannot contain consecutive hyphens or underscores' };\r\n    }\r\n\r\n    return { isValid: true, message: 'Username format is valid' };\r\n  }, [minLength, maxLength]);\r\n\r\n  const timeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  // Debounced function to check username availability\r\n  const checkUsernameAvailability = useCallback(\r\n    async (username: string) => {\r\n      // Clear existing timeout\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current);\r\n      }\r\n\r\n      // custom debounce using setTimeout\r\n      timeoutRef.current = setTimeout(async () => {\r\n        // Don't check if it's the same as last checked\r\n        if (username === lastCheckedUsername) {\r\n          return;\r\n        }\r\n\r\n        // If username matches current user's username, consider it available\r\n        if (currentUsername && username === currentUsername) {\r\n          setValidationResult({\r\n            isValid: true,\r\n            isAvailable: true,\r\n            message: 'This is your current username',\r\n            isLoading: false,\r\n          });\r\n          setLastCheckedUsername(username);\r\n          return;\r\n        }\r\n\r\n        setValidationResult(prev => ({ ...prev, isLoading: true }));\r\n\r\n        try {\r\n          // Try to get API URL from environment or use relative path\r\n          const baseUrl = typeof window !== 'undefined'\r\n            ? (window as any).__ENV__?.NEXT_PUBLIC_API_URL || process.env.NEXT_PUBLIC_API_URL || ''\r\n            : '';\r\n\r\n          // Use /api/v1 prefix for the backend endpoint\r\n          const apiUrl = baseUrl ? `${baseUrl}/auth/check-username` : '/api/v1/auth/check-username';\r\n\r\n          const response = await fetch(apiUrl, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ username }),\r\n          });\r\n\r\n          if (response.ok) {\r\n            const data = await response.json();\r\n            setValidationResult({\r\n              isValid: true,\r\n              isAvailable: data.available,\r\n              message: data.available ? 'Username is available!' : 'Username is already taken',\r\n              isLoading: false,\r\n            });\r\n            setLastCheckedUsername(username);\r\n          } else {\r\n            // Fallback: assume username is available if API fails\r\n            setValidationResult({\r\n              isValid: true,\r\n              isAvailable: true,\r\n              message: 'Username format is valid',\r\n              isLoading: false,\r\n            });\r\n          }\r\n        } catch (error) {\r\n          console.warn('Username availability check failed:', error);\r\n          // Fallback: assume username is available if API fails\r\n          setValidationResult({\r\n            isValid: true,\r\n            isAvailable: true,\r\n            message: 'Username format is valid',\r\n            isLoading: false,\r\n          });\r\n        }\r\n      }, debounceMs);\r\n    },\r\n    [lastCheckedUsername, debounceMs, currentUsername]\r\n  );\r\n\r\n  const validateUsername = useCallback(\r\n    async (username: string) => {\r\n      const formatValidation = validateFormat(username);\r\n\r\n      if (!formatValidation.isValid) {\r\n        setValidationResult({\r\n          isValid: false,\r\n          isAvailable: false,\r\n          message: formatValidation.message,\r\n          isLoading: false,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Check availability for valid usernames\r\n      if (username.length >= minLength) {\r\n        await checkUsernameAvailability(username);\r\n      } else {\r\n        setValidationResult({\r\n          isValid: false,\r\n          isAvailable: false,\r\n          message: formatValidation.message,\r\n          isLoading: false,\r\n        });\r\n      }\r\n    },\r\n    [validateFormat, checkUsernameAvailability, minLength]\r\n  );\r\n\r\n  const resetValidation = useCallback(() => {\r\n    setValidationResult({\r\n      isValid: false,\r\n      isAvailable: null,\r\n      message: '',\r\n      isLoading: false,\r\n    });\r\n    setLastCheckedUsername('');\r\n  }, []);\r\n\r\n  return {\r\n    validationResult,\r\n    validateUsername,\r\n    resetValidation,\r\n  };\r\n}\r\n\r\n// Helper function to generate username suggestions\r\nexport function generateUsernameSuggestions(baseName: string): string[] {\r\n  const base = baseName.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 10);\r\n  const suggestions = [];\r\n  const randomNumbers = [123, 456, 789, 2024, 2025];\r\n  const suffixes = ['', '_', '-', '___', '__', 'dev', 'app', 'user'];\r\n\r\n  for (let i = 0; i < 5; i++) {\r\n    const randomNum = randomNumbers[Math.floor(Math.random() * randomNumbers.length)];\r\n    const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];\r\n    suggestions.push(`${base}${suffix}${randomNum}`);\r\n  }\r\n\r\n  return [...new Set(suggestions)].slice(0, 5);\r\n}"],"mappings":"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","names":[]}